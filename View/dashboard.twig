{% extends 'layout.twig' %}


{% block content %}
    <div class="jumbotron">
        <div  class="container">
            <h1>Dashboard de {{ app.session.user.pseudo }} </h1>
            <p>Bienvenue sur votre tableau de bord Cinemood</p>
        </div>
    </div>

    <div id="innerContent" class="container">
        <h2>Vos classements</h2>

        <div>
            <div class="media mb-4">
{#                <form action="" method="post">#}
                    <table class="table table-dark">
                        <thead class="">
                            <tr class="d-flex">
                                <th scope="col" class="col-2 text-center">Films</th>
                                <th scope="col" class="col-3 text-center">Catégories</th>
                                <th scope="col" class="col-7 text-center">Commentaires</th>
                            </tr>
                        </thead>
                        <tbody class="">
                        {% if mcuList is iterable %}
                            {% for MCUConnection in mcuList %}
                                {# Boucle affichage des connexions : #}
                                <tr class="d-flex">
                                    <td class="col-2 text-center">
                                        <a href="{{ app.basepath }}movie/{{ MCUConnection.movieId }}">
                                            <figure class="">
                                                {% if MCUConnection.poster_path  %}
                                                    <img src='http://image.tmdb.org/t/p/w92{{ MCUConnection.poster_path }}' alt="{{ MCUConnection.title }} poster">
                                                {% else %}
                                                    <img style="width : 92px; height : 138px;" src='{{ app.basepath }}Public/img/no_poster.png' alt="Poster not found">
                                                {% endif %}
                                                <figcaption>{{ MCUConnection.title }}</figcaption>
                                            </figure>
                                        </a>
                                    </td>
                                    <td class="col-3 text-center">
                                        <a href="{{ app.basepath }}category/{{ MCUConnection.categoryId }}">
                                            <p class="categoryElt" style="background-color: {{ MCUConnection.background_color }}; color : {{ MCUConnection.font_color }} "> {{ MCUConnection.nom }}</p>
                                        </a>
                                    </td>
                                    <td id="nwl_comment_cell_{{ MCUConnection.id }}" class="col-7 nwl_comment_cell">
                                        <div id="comment_elt_{{ MCUConnection.id }}" class="comment_elt" contenteditable="false" >{{ MCUConnection.justificationComment }} </div>
                                        <button class="btn editComment" data-mcuId ="{{ MCUConnection.id }}" ><i class="far fa-edit"></i></button>
                                        <button  class="btn sendComment" data-mcuId ="{{ MCUConnection.id }}">Valider</button>
                                        {#                                        <form class="ajax" method="POST" action="{{ app.basepath }}editComment/{{ MCUConnection.id  }}" >#}
                                        {#                                            <textarea name="newComment">{{ MCUConnection.justificationComment }} </textarea>#}
{#                                            <button type="submit" class="submitBtn">Enregistrer </button>#}
{#                                            <input type="submit"  value="Enregistrer">#}

{#                                        </form>#}
                                    </td>
                                </tr>
                                {# Fin du foreach #}
                            {% endfor %}
                        {% else %}
                            {# mcuList is probably a string #}
                            <tr class="d-flex">
                                <td class="col-12 text-center">
                                    <h5 class="mt-0">{{ mcuList }}</h5>
                                </td>
                            </tr>
                        {% endif %}

                            <tfoot>
                                <tr class="d-flex">
                                    <th scope="col" class="col-2">Films</th>
                                    <th scope="col" class="col-3">Categories</th>
                                    <th scope="col" class="col-7">Commentaires</th>
                                </tr>
                            </tfoot>
                        </tbody>
                    </table>
{#                </form>#}
            </div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}

    <script>
        $(document).ready(function(){
            var allButtons = $('button[class^=btn]');

            // On abonne chaque bouton à un evt click
            for (var i = 0; i < allButtons.length; i++) {
                allButtons[i].addEventListener('click', function() {
                    if(this.classList.contains("editComment")){
                        var that = $(this),
                            commentDiv = $(this).siblings(".comment_elt"),
                            commentDivId = $(commentDiv).attr("id"),
                            sendBtn = $(this).siblings(".sendComment"),
                            thisParentCellId = $(this).parent().attr("id"),
                            mcuId =  this.getAttribute("data-mcuId");
                        $(commentDiv).attr("contenteditable", "true");
                        $(this).hide();
                        $(sendBtn).show();
                        $(sendBtn).on('click', function() {
                            if ( confirm( "Êtes-vous sur-e de vouloir enregistrer ces modifications? " + commentDivId + " " + thisParentCellId ) ) {
                                let comment = $(this).siblings(".comment_elt").text();
                                // Code à éxécuter si le l'utilisateur clique sur "OK"
                                testAjax("editComment/" + mcuId, comment, thisParentCellId, callback);
                            }
                        });
                    }
                });
            }


            function testAjax(url, comment, thisParentCellId, callback){ // actions administrateur
                var xhr = new XMLHttpRequest();
                let returnValue;
                let formData = new FormData();
                formData.append("comment", comment);
                xhr.open('POST','{{ app.basepath }}' + url );

                xhr.addEventListener('readystatechange', function() { // On gère ici une requête asynchrone
                    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) { // Si le fichier est chargé sans erreur
                        let response = xhr.response;
                        console.log(response);
                        callback(response, thisParentCellId);
                    } else if (xhr.readyState === XMLHttpRequest.DONE && xhr.status != 200) { // En cas d'erreur !
                        console.error('Echec HTTP : code' + xhr.status);
                    }
                });
                xhr.send(formData);
            }

            function callback(response, parentCellId) {
                let commentDiv = $("#"+parentCellId).find(".comment_elt"),
                    editBtn = $("#"+parentCellId).find(".editComment"),
                    sendBtn = $("#"+parentCellId).find(".sendComment");

                $(commentDiv).attr("contenteditable", "false");
                $(commentDiv).text(response);
                $(editBtn).show();
                $(sendBtn).hide();
            }

        });
    </script>

{% endblock %}
